<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Hoare Logic - Decorated Program | Chew’s Everyday Blog</title>
<meta name="generator" content="Jekyll v3.9.3" />
<meta property="og:title" content="Hoare Logic - Decorated Program" />
<meta name="author" content="Chew Y. Feng" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Decoration and Automated Verification" />
<meta property="og:description" content="Decoration and Automated Verification" />
<link rel="canonical" href="/software-foundations/2024/02/15/Decorated-Program.html" />
<meta property="og:url" content="/software-foundations/2024/02/15/Decorated-Program.html" />
<meta property="og:site_name" content="Chew’s Everyday Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-02-15T00:00:00+11:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Hoare Logic - Decorated Program" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Chew Y. Feng"},"dateModified":"2024-02-15T21:47:25+11:00","datePublished":"2024-02-15T00:00:00+11:00","description":"Decoration and Automated Verification","headline":"Hoare Logic - Decorated Program","mainEntityOfPage":{"@type":"WebPage","@id":"/software-foundations/2024/02/15/Decorated-Program.html"},"url":"/software-foundations/2024/02/15/Decorated-Program.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="/feed.xml" title="Chew&apos;s Everyday Blog" /><script>
    // for MathJax inline
    window.MathJax = {
      tex: {
        inlineMath: [['_', '_'], ['$', '$'], ['\\(', '\\)']]
      }
    };
  </script>
  <script type="text/javascript" id="MathJax-script" async
    src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/css-doodle/0.37.4/css-doodle.min.js"></script>
  <link rel="stylesheet"
          href="https://fonts.googleapis.com/css?family=Teko">
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-4TZZDRT6JY"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-4TZZDRT6JY');
  </script>
</head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Chew&#39;s Everyday Blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a><a class="page-link" href="/categories/">Categories</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="page-content-background">
        <css-doodle click-to-update>
          <style>
            @grid: 1 / 100vw 100vh / #0a0c27;
            background-size: 200px 200px;
            background-image: @doodle(
              @grid: 6 / 100%;
              @size: 4px;
              font-size: 4px;
              color: hsl(@r240, 30%, 50%);
              box-shadow: @m3x5(
                calc(4em - @nx * 1em) calc(@ny * 1em)
                  @p(@m3(currentColor), @m2(transparent)),
                calc(2em + @nx * 1em) calc(@ny * 1em)
                  @lp
              );
            );
          </style>
        </css-doodle>
      </div>
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Hoare Logic - Decorated Program</h1>
    <p class="post-meta"><span class="tags">
        
          <span>Coq</span>
        
          <span>PLT</span>
        
      </span><time class="dt-published" datetime="2024-02-15T00:00:00+11:00" itemprop="datePublished">
        Posted At: Feb 15, 2024
      </time><time>
        Modified At: Feb 15, 2024
      </time><span class="dt-tags">
        Category:
        
          <span>Software-Foundations</span>
        
      </span></p>
  </header>


  <div class="post-content e-content" itemprop="articleBody">
    <ul id="markdown-toc">
  <li><a href="#decorated-programs" id="markdown-toc-decorated-programs">Decorated Programs</a>    <ul>
      <li><a href="#simplified-decorated-programs" id="markdown-toc-simplified-decorated-programs">Simplified Decorated Programs</a></li>
    </ul>
  </li>
  <li><a href="#automated-verification" id="markdown-toc-automated-verification">Automated Verification</a></li>
  <li><a href="#finding-loop-invariants" id="markdown-toc-finding-loop-invariants">Finding loop invariants</a></li>
  <li><a href="#summary" id="markdown-toc-summary">Summary</a></li>
  <li><a href="#referrecne" id="markdown-toc-referrecne">Referrecne</a></li>
</ul>

<h2 id="decorated-programs">Decorated Programs</h2>
<p>The aesthetics of Hoare Logic is that it follows the structure of the program itself, which enables a powerful way to reason about a program – by decoration.</p>

<p>This naive program which subtracts a number is from the PLT series<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup>.</p>
<pre><code class="language-plain">{{ True }} -&gt;&gt; // 1
{{ m = m }}
  X := m
		 {{ X = m }} -&gt;&gt;
		 {{ X = m /\ p = p }};
  Z := p;
		 {{ X = m /\ Z = p }} -&gt;&gt;
		 {{ Z - X = p - m }}
  while X ≠ 0 do
		 {{ Z - X = p - m /\ X ≠ 0 }} -&gt;&gt;
		 {{ (Z - 1) - (X - 1) = p - m }}
	Z := Z - 1
		 {{ Z - (X - 1) = p - m }};
	X := X - 1
		 {{ Z - X = p - m }} // 2
  end
{{ Z - X = p - m /\ ¬(X ≠ 0) }} -&gt;&gt;
{{ Z = p - m }}
</code></pre>

<p>In this example, we showed that the result of the program is indeed <code class="language-plaintext highlighter-rouge">p - m</code> by a <em>decorated proof</em>. Each line accompanies an assertion which states the condition that the program state meets. The mark 1 “narrows down” the assertion, which is discussed in the previous article<sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote" rel="footnote">2</a></sup>. To remind it, we can use a weaker assertion to replace a stronger one to meet the requirement of the proof goal. The <em>loop invariant</em> (mark 2) states the condition that the loop satisfies. For assignments, conditions and most other commands that do not involve loops, finding the assertions is fairly easy by following the rules of Hoare Logic. We could see finding loop invariant is the creative part of this art.</p>

<p>One could prove a decorated proof is indeed logically correct by an almost automated process - a “prover” (proof assistant) could look at each assertion and line of programs to decide if the deduction is correct. The reason why it could be automated is that the rules of Hoare logic are mechanical enough, as discussed in the previous post<sup id="fnref:2:1" role="doc-noteref"><a href="#fn:2" class="footnote" rel="footnote">2</a></sup>.</p>
<h3 id="simplified-decorated-programs">Simplified Decorated Programs</h3>
<p>The straightforward way to formalize a decorated program is to present two assertions to each one command. Just like the classic Hoare logic statement:
\({\displaystyle \{P\}C\{Q\}}\)
But it turns out to be too verbose that even reading it makes people frustrated.  A decorated program which contains two <code class="language-plaintext highlighter-rouge">skip</code> would look like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{{P}} ({{P}} skip {{P}}) ; ({{P}} skip {{P}}) {{P}}
</code></pre></div></div>

<p>An obvious observation is that for two sequential commands, the postcondition of the former one is the precondition of the later one. So we could agree that it’s sound to remove one of it.</p>

<p>For <code class="language-plaintext highlighter-rouge">skip</code> command, apparently, the assertion should not change after the execution. So we don’t need to provide the precondition.</p>
<blockquote>
  <p>[!NOTE] Discussion
Why not omit the postconditions instead? Because the preconditions are always provided either from the start of the program or from the previous command.</p>
</blockquote>

<p>Similarly, we could only provide postconditions of assignments, as the preconditions could be derived easily.</p>

<p>Loops <code class="language-plaintext highlighter-rouge">while b do d</code> can be simplified by omitting the assertion inside the commands because they can be derived from the preconditions and the postconditions.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>while b do {{ P }} d end {{ Q }}
</code></pre></div></div>

<p>At last, we arrived to the simplified version of decorated programs, which can be implemented in Coq with some notation magic. The full implementation could be found on<sup id="fnref:1:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup>.</p>
<h2 id="automated-verification">Automated Verification</h2>
<p>A decorated program could be translated to a sequence of verification conditions. By reading each line of the program and the related condition, a proof assistant is able to decide whether the condition could be satisfied.</p>

<p>Let’s look at the standard Hoare triple:
\({\displaystyle \{P\}C\{Q\}}\)
The condition is whether the Hoare triple could be proved <em>valid</em>. The command $C$ might be composed by a sequence of commands, and they can be verified mechanically.  Formally, a proof assistant would walk recursively into the command $C$ and generated a big conjunction that checks</p>
<ul>
  <li><em>Local consistency</em> of each command and</li>
  <li>To “bridge the gap” try to narrow down the assertion found in the program and the assertion imposed by the context. This post adopts the notation  <code class="language-plaintext highlighter-rouge">-&gt;&gt;</code> to notate this “narrowing down” from PLT series<sup id="fnref:1:2" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup>.
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  "P-&gt;&gt;Q" &lt;-&gt; forall (st: State), P st -&gt; Q st
</code></pre></div>    </div>
  </li>
</ul>

<p>A decorated command is local consistent with a precondition <code class="language-plaintext highlighter-rouge">P</code> if</p>
<ul>
  <li>it is a skip <code class="language-plaintext highlighter-rouge">skip;{Q}</code> and  <code class="language-plaintext highlighter-rouge">P -&gt;&gt; Q</code>.</li>
  <li>it is an assignment <code class="language-plaintext highlighter-rouge">X:=a {Q}</code> and <code class="language-plaintext highlighter-rouge">P -&gt;&gt; Q[X|-&gt;a]</code></li>
  <li>it is a condition
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  if b then {{P1}} d1 else {{P2}} d2 end {{Q}}
</code></pre></div>    </div>
    <ul>
      <li><code class="language-plaintext highlighter-rouge">P /\ b -&gt;&gt; P1</code></li>
      <li><code class="language-plaintext highlighter-rouge">P /\ ~b -&gt;&gt; P2</code></li>
      <li><code class="language-plaintext highlighter-rouge">post P1 -&gt;&gt; Q</code></li>
      <li><code class="language-plaintext highlighter-rouge">post P2 -&gt;&gt; Q</code>
  where <code class="language-plaintext highlighter-rouge">post</code> is to get the postcondition of a decorated program</li>
    </ul>
  </li>
  <li>it is a loop
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  while b do {{Q}} d end {{R}}
</code></pre></div>    </div>
    <ul>
      <li><code class="language-plaintext highlighter-rouge">P /\ b -&gt;&gt; Q</code></li>
      <li><code class="language-plaintext highlighter-rouge">P /\ ~b -&gt;&gt; R</code></li>
      <li><code class="language-plaintext highlighter-rouge">post d /\ b -&gt;&gt; Q</code></li>
      <li><code class="language-plaintext highlighter-rouge">post d /\ ~b -&gt;&gt; R</code></li>
    </ul>
  </li>
  <li>if all explicit usages of <code class="language-plaintext highlighter-rouge">-&gt;&gt;</code> are valid</li>
</ul>

<p>Following these rules, an automated proof program could be developed.</p>
<h2 id="finding-loop-invariants">Finding loop invariants</h2>
<p>Once the outermost precondition and postcondition are chosen, the only left creative part of this “decorated” art is finding the loop invariants. You can’t choose an invariant that is too weak (such as <code class="language-plaintext highlighter-rouge">st -&gt; True</code>), because you’d need it to bridge the following conditions. Similarly, you can’t choose an invariant that is too strong, because it would be extremely hard or impossible to prove. It is indeed an art of finding the most appropriate loop invariants.</p>

<p>There is no silver bullet to solve the problem, but a few tips might help:</p>
<ul>
  <li>Try to use the strongest condition as the invariant first (the postcondition of the loop), and see what made it fails. Then adjust the invariants to a more “realistic one”</li>
  <li>Think about what the loop does and, how, by the end of the loop, the assertion <code class="language-plaintext highlighter-rouge">Q /\ b</code> is useful for proving the postcondition.</li>
  <li>What variables are used in the loop and how to propagate these variables into the information that the invariant carries.</li>
</ul>

<h2 id="summary">Summary</h2>
<ul>
  <li>Decorated Programs could be viewed as proofs of programs.</li>
  <li>Simplified Decorated Programs are equivalent to a fully decorated one, and it could help to avoid verbose, and thus, easier to read.</li>
  <li>The verification of a decorated program could be made automated.</li>
  <li>Finding loop invariants is relatively hard in this art.</li>
</ul>

<h2 id="referrecne">Referrecne</h2>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p>https://softwarefoundations.cis.upenn.edu/plf-current/Hoare2.html <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a> <a href="#fnref:1:1" class="reversefootnote" role="doc-backlink">&#8617;<sup>2</sup></a> <a href="#fnref:1:2" class="reversefootnote" role="doc-backlink">&#8617;<sup>3</sup></a></p>
    </li>
    <li id="fn:2" role="doc-endnote">
      <p>https://excitedspider.github.io/software-foundations/2024/02/02/Hoare-Logic-Basic.html <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a> <a href="#fnref:2:1" class="reversefootnote" role="doc-backlink">&#8617;<sup>2</sup></a></p>
    </li>
  </ol>
</div>

  </div><a class="u-url" href="/software-foundations/2024/02/15/Decorated-Program.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    
    <div class="footer-col-wrapper">
      <div class="footer-col">
        <h2 class="footer-heading">Chew&#39;s Everyday Blog</h2>By wisdom a house is built, and through understanding it is established.</div>
      <div class="footer-col">
        <ul class="contact-list">
          <li class="p-name">Author: Chew Y. Feng</li><li>
              <span>
                Mail: 
              </span>
            <a class="u-email" href="mailto:chew.y.feng@outlook.com">chew.y.feng@outlook.com</a></li><div>
              Find me:<ul class="social-media-list"><li><a href="https://github.com/excitedspider"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">excitedspider</span></a></li><li><a href="https://www.linkedin.com/in/qiuyi-feng-348968287"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#linkedin"></use></svg> <span class="username">qiuyi-feng-348968287</span></a></li></ul>
</div>
            <div class="footer-col-rss">
              <p class="rss-subscribe">subscribe <a href="/feed.xml">via RSS</a></p>
            </div>
        </ul>
      </div>

    </div>

  </div>

</footer>
</body>

</html>
